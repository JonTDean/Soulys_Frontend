{"ast":null,"code":"import DrawMethods from './DrawMethods.js';\nimport PenManager from '../penmanger/PenManager.js';\nimport HitAreaManager from '../hitareamanager/HitAreaManager.js';\nimport SetInteractive from './SetInteractive.js';\nimport CONST from '../const.js';\nimport WrapText from './WrapText.js';\nimport Clone from '../../../../utils/object/Clone.js';\nconst GetValue = Phaser.Utils.Objects.GetValue;\nconst NO_WRAP = CONST.NO_WRAP;\nconst NO_NEWLINE = CONST.NO_NEWLINE;\n\nclass CanvasText {\n  constructor(config) {\n    this.parent = config.parent;\n    this.context = GetValue(config, 'context', null);\n    this.canvas = this.context.canvas;\n    this.parser = GetValue(config, 'parser', null);\n    this.defatultStyle = GetValue(config, 'style', null);\n    this.autoRound = true;\n    this.pensPool = GetValue(config, 'pensPool', null);\n    this.penManager = this.newPenManager();\n    this._tmpPenManager = null;\n    this.hitAreaManager = new HitAreaManager();\n    var context = this.context;\n\n    this.getTextWidth = function (text) {\n      return context.measureText(text).width;\n    };\n  }\n\n  destroy() {\n    this.context = undefined;\n    this.canvas = undefined;\n    this.parser = undefined;\n    this.defatultStyle = undefined;\n\n    if (this.penManager) {\n      this.penManager.destroy();\n      this.penManager = undefined;\n    }\n\n    if (this._tmpPenManager) {\n      this._tmpPenManager.destroy();\n\n      this._tmpPenManager = undefined;\n    }\n\n    if (this.hitAreaManager) {\n      this.hitAreaManager.destroy();\n      this.hitAreaManager = undefined;\n    }\n  }\n\n  updatePenManager(text, wrapMode, wrapWidth, lineHeight, penManager) {\n    if (penManager === undefined) {\n      penManager = this.penManager;\n    }\n\n    penManager.freePens();\n\n    if (text === \"\") {\n      return penManager;\n    }\n\n    var canvas = this.canvas;\n    var context = this.context;\n    var cursorX = 0,\n        cursorY = 0;\n    var plainText, curProp, curStyle;\n    var match = this.parser.splitText(text),\n        result,\n        wrapLines;\n\n    for (var i = 0, len = match.length; i < len; i++) {\n      result = this.parser.tagTextToProp(match[i], curProp);\n      plainText = result.plainText;\n      curProp = result.prop;\n\n      if (curProp.img) {\n        // Image tag                \n        var imgWidth = this.imageManager.getOuterWidth(curProp.img);\n\n        if (wrapWidth > 0 && wrapMode !== NO_WRAP) {\n          // Wrap mode\n          if (wrapWidth < cursorX + imgWidth) {\n            penManager.addNewLinePen();\n            cursorY += lineHeight;\n            cursorX = 0;\n          }\n        }\n\n        penManager.addImagePen(cursorX, cursorY, imgWidth, Clone(curProp));\n        cursorX += imgWidth;\n      } else if (plainText !== '') {\n        // wrap text to lines\n        // Save the current context.\n        this.context.save();\n        curStyle = this.parser.propToContextStyle(this.defatultStyle, curProp);\n        curStyle.buildFont();\n        curStyle.syncFont(canvas, context);\n        curStyle.syncStyle(canvas, context);\n        wrapLines = WrapText(plainText, this.getTextWidth, wrapMode, wrapWidth, cursorX); // add pens\n\n        var n;\n\n        for (var j = 0, jLen = wrapLines.length; j < jLen; j++) {\n          n = wrapLines[j];\n          penManager.addTextPen(n.text, cursorX, cursorY, n.width, Clone(curProp), n.newLineMode);\n\n          if (n.newLineMode !== NO_NEWLINE) {\n            cursorX = 0;\n            cursorY += lineHeight;\n          } else {\n            cursorX += n.width;\n          }\n        }\n\n        this.context.restore();\n      }\n    }\n\n    return penManager;\n  }\n\n  get startXOffset() {\n    var defatultStyle = this.defatultStyle;\n    return defatultStyle.strokeThickness / 2;\n  }\n\n  get startYOffset() {\n    var defatultStyle = this.defatultStyle;\n    return defatultStyle.strokeThickness / 2 + defatultStyle.metrics.ascent;\n  }\n\n  get lines() {\n    return this.penManager.lines;\n  }\n\n  get desplayLinesCount() {\n    var linesCount = this.penManager.linesCount,\n        maxLines = this.defatultStyle.maxLines;\n\n    if (maxLines > 0 && linesCount > maxLines) {\n      linesCount = maxLines;\n    }\n\n    return linesCount;\n  }\n\n  get linesWidth() {\n    return this.penManager.getMaxLineWidth();\n  }\n\n  get linesHeight() {\n    var linesCount = this.desplayLinesCount;\n    var linesHeight = this.defatultStyle.lineHeight * linesCount;\n\n    if (linesCount > 0) {\n      linesHeight -= this.defatultStyle.lineSpacing;\n    }\n\n    return linesHeight;\n  }\n\n  get imageManager() {\n    return this.parent.imageManager;\n  }\n\n  newPenManager() {\n    return new PenManager({\n      pensPool: this.pensPool,\n      tagToText: this.parser.propToTagText,\n      tagToTextScope: this.parser\n    });\n  }\n\n  get tmpPenManager() {\n    if (this._tmpPenManager === null) {\n      this._tmpPenManager = this.newPenManager();\n    }\n\n    return this._tmpPenManager;\n  }\n\n  getPlainText(text, start, end) {\n    var plainText;\n\n    if (text == null) {\n      plainText = this.penManager.plainText;\n    } else {\n      var m,\n          match = this.parser.splitText(text, 1); // PLAINTEXTONLY_MODE\n\n      plainText = \"\";\n\n      for (var i = 0, len = match.length; i < len; i++) {\n        plainText += match[i];\n      }\n    }\n\n    if (start != null || end != null) {\n      if (start == null) {\n        start = 0;\n      }\n\n      if (end == null) {\n        end = plainText.length;\n      }\n\n      plainText = plainText.substring(start, end);\n    }\n\n    return plainText;\n  }\n\n  getPenManager(text, retPenManager) {\n    if (text === undefined) {\n      return this.copyPenManager(retPenManager, this.penManager);\n    }\n\n    if (retPenManager === undefined) {\n      retPenManager = this.newPenManager();\n    }\n\n    var defatultStyle = this.defatultStyle;\n    this.updatePenManager(text, defatultStyle.wrapMode, defatultStyle.wrapWidth, defatultStyle.lineHeight, retPenManager);\n    return retPenManager;\n  }\n\n  getText(text, start, end, wrap) {\n    if (text == null) {\n      return this.penManager.getSliceTagText(start, end, wrap);\n    }\n\n    var penManager = this.tmpPenManager;\n    var defatultStyle = this.defatultStyle;\n    this.updatePenManager(text, defatultStyle.wrapMode, defatultStyle.wrapWidth, defatultStyle.lineHeight, penManager);\n    return penManager.getSliceTagText(start, end, wrap);\n  }\n\n  copyPenManager(ret, src) {\n    if (src === undefined) {\n      src = this.penManager;\n    }\n\n    return src.copy(ret);\n  }\n\n  getTextWidth(penManager) {\n    if (penManager === undefined) {\n      penManager = this.penManager;\n    }\n\n    return penManager.getMaxLineWidth();\n  }\n\n  getLastPen(penManager) {\n    if (penManager === undefined) {\n      penManager = this.penManager;\n    }\n\n    return penManager.lastPen;\n  }\n\n}\n\n;\nvar methods = {\n  setInteractive: SetInteractive\n};\nObject.assign(CanvasText.prototype, DrawMethods, methods);\nexport default CanvasText;","map":{"version":3,"sources":["/home/jon/code/Projects/Soulys/frontend/node_modules/phaser3-rex-plugins/plugins/gameobjects/text/textbase/canvastext/CanvasText.js"],"names":["DrawMethods","PenManager","HitAreaManager","SetInteractive","CONST","WrapText","Clone","GetValue","Phaser","Utils","Objects","NO_WRAP","NO_NEWLINE","CanvasText","constructor","config","parent","context","canvas","parser","defatultStyle","autoRound","pensPool","penManager","newPenManager","_tmpPenManager","hitAreaManager","getTextWidth","text","measureText","width","destroy","undefined","updatePenManager","wrapMode","wrapWidth","lineHeight","freePens","cursorX","cursorY","plainText","curProp","curStyle","match","splitText","result","wrapLines","i","len","length","tagTextToProp","prop","img","imgWidth","imageManager","getOuterWidth","addNewLinePen","addImagePen","save","propToContextStyle","buildFont","syncFont","syncStyle","n","j","jLen","addTextPen","newLineMode","restore","startXOffset","strokeThickness","startYOffset","metrics","ascent","lines","desplayLinesCount","linesCount","maxLines","linesWidth","getMaxLineWidth","linesHeight","lineSpacing","tagToText","propToTagText","tagToTextScope","tmpPenManager","getPlainText","start","end","m","substring","getPenManager","retPenManager","copyPenManager","getText","wrap","getSliceTagText","ret","src","copy","getLastPen","lastPen","methods","setInteractive","Object","assign","prototype"],"mappings":"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","sourcesContent":["import DrawMethods from './DrawMethods.js';\r\nimport PenManager from '../penmanger/PenManager.js';\r\nimport HitAreaManager from '../hitareamanager/HitAreaManager.js';\r\nimport SetInteractive from './SetInteractive.js';\r\nimport CONST from '../const.js';\r\nimport WrapText from './WrapText.js';\r\nimport Clone from '../../../../utils/object/Clone.js';\r\n\r\nconst GetValue = Phaser.Utils.Objects.GetValue;\r\nconst NO_WRAP = CONST.NO_WRAP;\r\nconst NO_NEWLINE = CONST.NO_NEWLINE;\r\n\r\nclass CanvasText {\r\n    constructor(config) {\r\n        this.parent = config.parent;\r\n        this.context = GetValue(config, 'context', null);\r\n        this.canvas = this.context.canvas;\r\n        this.parser = GetValue(config, 'parser', null);\r\n        this.defatultStyle = GetValue(config, 'style', null);\r\n        this.autoRound = true;\r\n\r\n        this.pensPool = GetValue(config, 'pensPool', null);\r\n        this.penManager = this.newPenManager();\r\n        this._tmpPenManager = null;\r\n\r\n        this.hitAreaManager = new HitAreaManager();\r\n\r\n        var context = this.context;\r\n        this.getTextWidth = function (text) {\r\n            return context.measureText(text).width;\r\n        }\r\n    }\r\n\r\n    destroy() {\r\n        this.context = undefined;\r\n        this.canvas = undefined;\r\n        this.parser = undefined;\r\n        this.defatultStyle = undefined;\r\n\r\n        if (this.penManager) {\r\n            this.penManager.destroy();\r\n            this.penManager = undefined;\r\n        }\r\n        if (this._tmpPenManager) {\r\n            this._tmpPenManager.destroy();\r\n            this._tmpPenManager = undefined;\r\n        }\r\n        if (this.hitAreaManager) {\r\n            this.hitAreaManager.destroy();\r\n            this.hitAreaManager = undefined;\r\n        }\r\n    }\r\n\r\n    updatePenManager(text, wrapMode, wrapWidth, lineHeight, penManager) {\r\n        if (penManager === undefined) {\r\n            penManager = this.penManager;\r\n        }\r\n        penManager.freePens();\r\n        if (text === \"\") {\r\n            return penManager;\r\n        }\r\n\r\n        var canvas = this.canvas;\r\n        var context = this.context;\r\n\r\n        var cursorX = 0,\r\n            cursorY = 0;\r\n\r\n        var plainText, curProp, curStyle;\r\n        var match = this.parser.splitText(text),\r\n            result, wrapLines;\r\n        for (var i = 0, len = match.length; i < len; i++) {\r\n            result = this.parser.tagTextToProp(match[i], curProp);\r\n            plainText = result.plainText;\r\n            curProp = result.prop;\r\n\r\n            if (curProp.img) { // Image tag                \r\n                var imgWidth = this.imageManager.getOuterWidth(curProp.img);\r\n                if ((wrapWidth > 0) && (wrapMode !== NO_WRAP)) {  // Wrap mode\r\n                    if (wrapWidth < (cursorX + imgWidth)) {\r\n                        penManager.addNewLinePen();\r\n                        cursorY += lineHeight;\r\n                        cursorX = 0;\r\n                    }\r\n                }\r\n                penManager.addImagePen(cursorX, cursorY, imgWidth, Clone(curProp));\r\n                cursorX += imgWidth;\r\n\r\n            } else if (plainText !== '') {\r\n                // wrap text to lines\r\n                // Save the current context.\r\n                this.context.save();\r\n                curStyle = this.parser.propToContextStyle(\r\n                    this.defatultStyle,\r\n                    curProp\r\n                );\r\n                curStyle.buildFont();\r\n                curStyle.syncFont(canvas, context);\r\n                curStyle.syncStyle(canvas, context);\r\n                wrapLines = WrapText(plainText, this.getTextWidth, wrapMode, wrapWidth, cursorX);\r\n\r\n                // add pens\r\n                var n;\r\n                for (var j = 0, jLen = wrapLines.length; j < jLen; j++) {\r\n                    n = wrapLines[j];\r\n                    penManager.addTextPen(n.text, cursorX, cursorY, n.width, Clone(curProp), n.newLineMode);\r\n\r\n                    if (n.newLineMode !== NO_NEWLINE) {\r\n                        cursorX = 0;\r\n                        cursorY += lineHeight;\r\n                    } else {\r\n                        cursorX += n.width;\r\n                    }\r\n\r\n                }\r\n                this.context.restore();\r\n\r\n            }\r\n\r\n        }\r\n\r\n        return penManager;\r\n    }\r\n\r\n    get startXOffset() {\r\n        var defatultStyle = this.defatultStyle;\r\n        return (defatultStyle.strokeThickness / 2);\r\n    }\r\n\r\n    get startYOffset() {\r\n        var defatultStyle = this.defatultStyle;\r\n        return (defatultStyle.strokeThickness / 2) + defatultStyle.metrics.ascent;\r\n    }\r\n\r\n    get lines() {\r\n        return this.penManager.lines;\r\n    }\r\n\r\n    get desplayLinesCount() {\r\n        var linesCount = this.penManager.linesCount,\r\n            maxLines = this.defatultStyle.maxLines;\r\n        if ((maxLines > 0) && (linesCount > maxLines)) {\r\n            linesCount = maxLines;\r\n        }\r\n        return linesCount;\r\n    }\r\n\r\n    get linesWidth() {\r\n        return this.penManager.getMaxLineWidth();\r\n    }\r\n\r\n    get linesHeight() {\r\n        var linesCount = this.desplayLinesCount;\r\n        var linesHeight = (this.defatultStyle.lineHeight * linesCount);\r\n        if (linesCount > 0) {\r\n            linesHeight -= this.defatultStyle.lineSpacing;\r\n        }\r\n        return linesHeight;\r\n    }\r\n\r\n    get imageManager() {\r\n        return this.parent.imageManager;\r\n    }\r\n\r\n    newPenManager() {\r\n        return new PenManager({\r\n            pensPool: this.pensPool,\r\n            tagToText: this.parser.propToTagText,\r\n            tagToTextScope: this.parser\r\n        });\r\n    }\r\n\r\n    get tmpPenManager() {\r\n        if (this._tmpPenManager === null) {\r\n            this._tmpPenManager = this.newPenManager();\r\n        }\r\n        return this._tmpPenManager;\r\n    }\r\n\r\n    getPlainText(text, start, end) {\r\n        var plainText;\r\n        if (text == null) {\r\n            plainText = this.penManager.plainText;\r\n        } else {\r\n            var m, match = this.parser.splitText(text, 1); // PLAINTEXTONLY_MODE\r\n            plainText = \"\";\r\n            for (var i = 0, len = match.length; i < len; i++) {\r\n                plainText += match[i];\r\n            }\r\n        }\r\n\r\n        if ((start != null) || (end != null)) {\r\n            if (start == null) {\r\n                start = 0;\r\n            }\r\n            if (end == null) {\r\n                end = plainText.length;\r\n            }\r\n            plainText = plainText.substring(start, end);\r\n        }\r\n\r\n        return plainText;\r\n    }\r\n\r\n    getPenManager(text, retPenManager) {\r\n        if (text === undefined) {\r\n            return this.copyPenManager(retPenManager, this.penManager);\r\n        }\r\n\r\n        if (retPenManager === undefined) {\r\n            retPenManager = this.newPenManager();\r\n        }\r\n\r\n        var defatultStyle = this.defatultStyle;\r\n        this.updatePenManager(\r\n            text,\r\n            defatultStyle.wrapMode,\r\n            defatultStyle.wrapWidth,\r\n            defatultStyle.lineHeight,\r\n            retPenManager\r\n        );\r\n        return retPenManager;\r\n    }\r\n\r\n    getText(text, start, end, wrap) {\r\n        if (text == null) {\r\n            return this.penManager.getSliceTagText(start, end, wrap);\r\n        }\r\n\r\n        var penManager = this.tmpPenManager;\r\n        var defatultStyle = this.defatultStyle;\r\n        this.updatePenManager(\r\n            text,\r\n            defatultStyle.wrapMode,\r\n            defatultStyle.wrapWidth,\r\n            defatultStyle.lineHeight,\r\n            penManager\r\n        );\r\n\r\n        return penManager.getSliceTagText(start, end, wrap);\r\n    }\r\n\r\n    copyPenManager(ret, src) {\r\n        if (src === undefined) {\r\n            src = this.penManager;\r\n        }\r\n        return src.copy(ret);\r\n    }\r\n\r\n    getTextWidth(penManager) {\r\n        if (penManager === undefined) {\r\n            penManager = this.penManager;\r\n        }\r\n\r\n        return penManager.getMaxLineWidth();\r\n    }\r\n\r\n    getLastPen(penManager) {\r\n        if (penManager === undefined) {\r\n            penManager = this.penManager;\r\n        }\r\n\r\n        return penManager.lastPen;\r\n    }\r\n};\r\n\r\nvar methods = {\r\n    setInteractive: SetInteractive,\r\n}\r\n\r\nObject.assign(\r\n    CanvasText.prototype,\r\n    DrawMethods,\r\n    methods\r\n);\r\n\r\nexport default CanvasText;"]},"metadata":{},"sourceType":"module"}