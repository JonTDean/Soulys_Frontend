{"ast":null,"code":"import TickTask from '../../../utils/ticktask/TickTask.js';\nimport GetSceneObject from '../../../utils/system/GetSceneObject.js';\nimport GetValue from '../../../utils/object/GetValue.js';\nimport ArrayCopy from '../../../utils/array/Copy.js';\nimport RunCommands from '../../../runcommands.js';\nimport GetEventEmitter from '../../../utils/system/GetEventEmitter.js';\nimport IsArray from '../../../utils/object/IsArray.js';\n\nclass Player extends TickTask {\n  constructor(parent, config) {\n    super(parent, config);\n    this.parent = parent;\n    this.scene = GetSceneObject(parent);\n    this.resetFromJSON(config); // this function had been called in super(config)\n\n    this.boot();\n  }\n\n  resetFromJSON(o) {\n    this.isRunning = GetValue(o, 'isRunning', false);\n    this.state = GetValue(o, 'state', 0); // 0=idle, 1=run, 2=completed\n\n    this.commands = GetValue(o, 'commands', []); // [[dt, cmds], [dt, cmds], ...]\n\n    this.scope = GetValue(o, 'scope', undefined);\n    this.setTimeUnit(GetValue(o, 'timeUnit', 0));\n    this.setDtMode(GetValue(o, 'dtMode', 0));\n    this.setTimeScale(GetValue(o, 'timeScale', 1));\n    this.index = GetValue(o, 'index', 0);\n    this.nextDt = GetValue(o, 'nextDt', 0);\n    this.seek(GetValue(o, 'now', 0));\n    this.timeScale = GetValue(o, 'timeScale', 1);\n    return this;\n  }\n\n  toJSON() {\n    return {\n      isRunning: this.isRunning,\n      state: this.state,\n      commands: this.commands,\n      scope: this.scope,\n      timeUnit: this.timeUnit,\n      dtMode: this.dtMode,\n      index: this.index,\n      nextDt: this.nextDt,\n      now: this.now,\n      timeScale: this.timeScale,\n      tickingMode: this.tickingMode\n    };\n  }\n\n  boot() {\n    super.boot();\n    var parentEE = GetEventEmitter(this.parent);\n\n    if (parentEE) {\n      parentEE.on('destroy', this.destroy, this);\n    }\n  }\n\n  shutdown() {\n    super.shutdown();\n    this.parent = undefined;\n    this.scene = undefined;\n    this.commands = undefined;\n  }\n\n  destroy() {\n    this.shutdown();\n  }\n\n  startTicking() {\n    super.startTicking();\n    this.scene.events.on('update', this.update, this);\n  }\n\n  stopTicking() {\n    super.stopTicking();\n\n    if (this.scene) {\n      // Scene might be destoryed\n      this.scene.events.off('update', this.update, this);\n    }\n  }\n\n  load(commands, scope, config) {\n    this.stop();\n    var timeUnit = GetValue(config, 'timeUnit', undefined);\n\n    if (timeUnit !== undefined) {\n      this.setTimeUnit(timeUnit);\n    }\n\n    var dtMode = GetValue(config, 'dtMode', undefined);\n\n    if (dtMode !== undefined) {\n      this.setDtMode(dtMode);\n    }\n\n    commands = commands.filter(function (item) {\n      var dt = item[0];\n      return !isNaN(dt);\n    }).map(function (item) {\n      var dt = item[0];\n\n      if (typeof dt === 'string') {\n        item[0] = parseFloat(item[0]);\n      }\n\n      return item;\n    });\n\n    if (this.dtMode === 0) {\n      commands.sort(function (itemA, itemB) {\n        var dtA = itemA[0],\n            dtB = itemB[0];\n        return dtA > dtB ? 1 : dtA < dtB ? -1 : 0;\n      });\n    }\n\n    this.commands = commands;\n    this.scope = scope;\n    return this;\n  }\n\n  start(startAt) {\n    if (startAt === undefined) {\n      startAt = 0;\n    }\n\n    this.stop();\n    this.index = 0;\n    this.isRunning = true;\n    this.state = 1;\n    this.nextDt = this.getNextDt(0);\n    this.seek(startAt);\n    this.update();\n    return this;\n  }\n\n  pause() {\n    this.isRunning = false;\n    return this;\n  }\n\n  resume() {\n    this.isRunning = true;\n    return this;\n  }\n\n  stop() {\n    this.isRunning = false;\n    this.state = 0;\n    return this;\n  }\n\n  seek(time) {\n    this.now = time;\n    return this;\n  }\n\n  get isPlaying() {\n    return this.isRunning;\n  }\n\n  get completed() {\n    return this.state === 2;\n  }\n\n  setTimeScale(value) {\n    this.timeScale = value;\n  }\n\n  update(time, delta) {\n    if (!this.isRunning) {\n      return this;\n    }\n\n    if (time !== undefined) {\n      if (this.timeScale === 0 || delta === 0) {\n        return this;\n      }\n\n      this.now += delta * this.timeScale;\n    }\n\n    if (this.nextDt > this.now) {\n      return this;\n    }\n\n    while (1) {\n      // run a row\n      var item = this.commands[this.index];\n      var command = item[1];\n\n      if (!IsArray(command)) {\n        // [dt, fnName, param0, param1, ...]\n        command = ArrayCopy(CMD, item, 1);\n      }\n\n      RunCommands(command, this.scope);\n      this.emit('runcommand', command, this.scope); // run a row\n\n      if (this.index === this.commands.length - 1) {\n        this.complete();\n        return this;\n      } else {\n        // next dt\n        this.index++; // point to next item\n\n        this.nextDt = this.getNextDt(this.nextDt);\n\n        if (this.nextDt > this.now) {\n          return this;\n        } // next dt\n\n      }\n    }\n  }\n\n  complete() {\n    super.complete();\n    this.state = 2;\n  }\n\n  getNextDt(currentDt) {\n    var dt = this.commands[this.index][0];\n\n    if (this.timeUnit === 1) {\n      // sec mode\n      dt = dt * 1000;\n    }\n\n    if (this.dtMode === 1) {\n      dt += currentDt;\n    }\n\n    return dt;\n  }\n\n  setDtMode(dtMode) {\n    if (typeof dtMode === 'string') {\n      dtMode = DTMODE[dtMode];\n    }\n\n    this.dtMode = dtMode;\n    return this;\n  }\n\n  setTimeUnit(timeUnit) {\n    if (typeof timeUnit === 'string') {\n      timeUnit = TIMEUNITMODE[timeUnit];\n    }\n\n    this.timeUnit = timeUnit;\n    return this;\n  }\n\n}\n\nvar CMD = []; // reuse this array\n\nconst TIMEUNITMODE = {\n  ms: 0,\n  s: 1,\n  sec: 1\n};\nconst DTMODE = {\n  abs: 0,\n  absolute: 0,\n  inc: 1,\n  increment: 1\n};\nexport default Player;","map":{"version":3,"sources":["/home/jon/code/Projects/Soulys/frontend/node_modules/phaser3-rex-plugins/plugins/logic/runcommands/tcrp/Player.js"],"names":["TickTask","GetSceneObject","GetValue","ArrayCopy","RunCommands","GetEventEmitter","IsArray","Player","constructor","parent","config","scene","resetFromJSON","boot","o","isRunning","state","commands","scope","undefined","setTimeUnit","setDtMode","setTimeScale","index","nextDt","seek","timeScale","toJSON","timeUnit","dtMode","now","tickingMode","parentEE","on","destroy","shutdown","startTicking","events","update","stopTicking","off","load","stop","filter","item","dt","isNaN","map","parseFloat","sort","itemA","itemB","dtA","dtB","start","startAt","getNextDt","pause","resume","time","isPlaying","completed","value","delta","command","CMD","emit","length","complete","currentDt","DTMODE","TIMEUNITMODE","ms","s","sec","abs","absolute","inc","increment"],"mappings":"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","sourcesContent":["import TickTask from '../../../utils/ticktask/TickTask.js';\r\nimport GetSceneObject from '../../../utils/system/GetSceneObject.js';\r\nimport GetValue from '../../../utils/object/GetValue.js';\r\nimport ArrayCopy from '../../../utils/array/Copy.js';\r\nimport RunCommands from '../../../runcommands.js';\r\nimport GetEventEmitter from '../../../utils/system/GetEventEmitter.js';\r\nimport IsArray from '../../../utils/object/IsArray.js';\r\n\r\nclass Player extends TickTask {\r\n    constructor(parent, config) {\r\n        super(parent, config);\r\n\r\n        this.parent = parent;\r\n        this.scene = GetSceneObject(parent);\r\n        this.resetFromJSON(config); // this function had been called in super(config)\r\n        this.boot();\r\n    }\r\n\r\n    resetFromJSON(o) {\r\n        this.isRunning = GetValue(o, 'isRunning', false);\r\n        this.state = GetValue(o, 'state', 0); // 0=idle, 1=run, 2=completed\r\n        this.commands = GetValue(o, 'commands', []); // [[dt, cmds], [dt, cmds], ...]\r\n        this.scope = GetValue(o, 'scope', undefined);\r\n        this.setTimeUnit(GetValue(o, 'timeUnit', 0));\r\n        this.setDtMode(GetValue(o, 'dtMode', 0));\r\n        this.setTimeScale(GetValue(o, 'timeScale', 1));\r\n        this.index = GetValue(o, 'index', 0);\r\n        this.nextDt = GetValue(o, 'nextDt', 0);\r\n        this.seek(GetValue(o, 'now', 0));\r\n        this.timeScale = GetValue(o, 'timeScale', 1);\r\n        return this;\r\n    }\r\n\r\n    toJSON() {\r\n        return {\r\n            isRunning: this.isRunning,\r\n            state: this.state,\r\n            commands: this.commands,\r\n            scope: this.scope,\r\n            timeUnit: this.timeUnit,\r\n            dtMode: this.dtMode,\r\n            index: this.index,\r\n            nextDt: this.nextDt,\r\n            now: this.now,\r\n            timeScale: this.timeScale,\r\n            tickingMode: this.tickingMode\r\n        };\r\n    }\r\n\r\n    boot() {\r\n        super.boot();\r\n\r\n        var parentEE = GetEventEmitter(this.parent);\r\n        if (parentEE) {\r\n            parentEE.on('destroy', this.destroy, this);\r\n        }\r\n    }\r\n\r\n    shutdown() {\r\n        super.shutdown();\r\n\r\n        this.parent = undefined;\r\n        this.scene = undefined;\r\n        this.commands = undefined;\r\n    }\r\n\r\n    destroy() {\r\n        this.shutdown();\r\n    }\r\n\r\n    startTicking() {\r\n        super.startTicking();\r\n        this.scene.events.on('update', this.update, this);\r\n    }\r\n\r\n    stopTicking() {\r\n        super.stopTicking();\r\n        if (this.scene) { // Scene might be destoryed\r\n            this.scene.events.off('update', this.update, this);\r\n        }\r\n    }\r\n\r\n    load(commands, scope, config) {\r\n        this.stop();\r\n        var timeUnit = GetValue(config, 'timeUnit', undefined);\r\n        if (timeUnit !== undefined) {\r\n            this.setTimeUnit(timeUnit)\r\n        }\r\n        var dtMode = GetValue(config, 'dtMode', undefined);\r\n        if (dtMode !== undefined) {\r\n            this.setDtMode(dtMode);\r\n        }\r\n        commands = commands\r\n            .filter(function (item) {\r\n                var dt = item[0];\r\n                return !isNaN(dt);\r\n            })\r\n            .map(function (item) {\r\n                var dt = item[0];\r\n                if (typeof (dt) === 'string') {\r\n                    item[0] = parseFloat(item[0]);\r\n                }\r\n                return item;\r\n            });\r\n\r\n        if (this.dtMode === 0) {\r\n            commands.sort(function (itemA, itemB) {\r\n                var dtA = itemA[0],\r\n                    dtB = itemB[0];\r\n                return (dtA > dtB) ? 1 :\r\n                    (dtA < dtB) ? -1 : 0;\r\n            });\r\n        }\r\n\r\n        this.commands = commands;\r\n        this.scope = scope;\r\n        return this;\r\n    }\r\n\r\n    start(startAt) {\r\n        if (startAt === undefined) {\r\n            startAt = 0;\r\n        }\r\n\r\n        this.stop();\r\n        this.index = 0;\r\n        this.isRunning = true;\r\n        this.state = 1;\r\n        this.nextDt = this.getNextDt(0);\r\n        this.seek(startAt);\r\n        this.update();\r\n        return this;\r\n    }\r\n\r\n    pause() {\r\n        this.isRunning = false;\r\n        return this;\r\n    }\r\n\r\n    resume() {\r\n        this.isRunning = true;\r\n        return this;\r\n    }\r\n\r\n    stop() {\r\n        this.isRunning = false;\r\n        this.state = 0;\r\n        return this;\r\n    }\r\n\r\n    seek(time) {\r\n        this.now = time;\r\n        return this;\r\n    }\r\n\r\n    get isPlaying() {\r\n        return this.isRunning;\r\n    }\r\n\r\n    get completed() {\r\n        return (this.state === 2);\r\n    }\r\n\r\n    setTimeScale(value) {\r\n        this.timeScale = value;\r\n    }\r\n\r\n    update(time, delta) {\r\n        if (!this.isRunning) {\r\n            return this;\r\n        }\r\n\r\n        if (time !== undefined) {\r\n            if ((this.timeScale === 0) || (delta === 0)) {\r\n                return this;\r\n            }\r\n\r\n            this.now += (delta * this.timeScale);\r\n        }\r\n\r\n        if (this.nextDt > this.now) {\r\n            return this;\r\n        }\r\n        while (1) {\r\n            // run a row\r\n            var item = this.commands[this.index];\r\n            var command = item[1];\r\n            if (!IsArray(command)) { // [dt, fnName, param0, param1, ...]\r\n                command = ArrayCopy(CMD, item, 1);\r\n            }\r\n            RunCommands(command, this.scope);\r\n            this.emit('runcommand', command, this.scope);\r\n            // run a row\r\n\r\n            if (this.index === (this.commands.length - 1)) {\r\n                this.complete();\r\n                return this;\r\n            } else {\r\n                // next dt\r\n                this.index++; // point to next item\r\n                this.nextDt = this.getNextDt(this.nextDt);\r\n                if (this.nextDt > this.now) {\r\n                    return this;\r\n                }\r\n                // next dt\r\n            }\r\n\r\n        }\r\n    }\r\n\r\n    complete() {\r\n        super.complete();\r\n        this.state = 2;\r\n    }\r\n\r\n    getNextDt(currentDt) {\r\n        var dt = this.commands[this.index][0];\r\n        if (this.timeUnit === 1) { // sec mode\r\n            dt = dt * 1000;\r\n        }\r\n\r\n        if (this.dtMode === 1) {\r\n            dt += currentDt;\r\n        }\r\n\r\n        return dt;\r\n    }\r\n\r\n    setDtMode(dtMode) {\r\n        if (typeof (dtMode) === 'string') {\r\n            dtMode = DTMODE[dtMode];\r\n        }\r\n        this.dtMode = dtMode;\r\n        return this;\r\n    }\r\n\r\n    setTimeUnit(timeUnit) {\r\n        if (typeof (timeUnit) === 'string') {\r\n            timeUnit = TIMEUNITMODE[timeUnit];\r\n        }\r\n        this.timeUnit = timeUnit;\r\n        return this;\r\n    }\r\n}\r\n\r\nvar CMD = []; // reuse this array\r\n\r\nconst TIMEUNITMODE = {\r\n    ms: 0,\r\n    s: 1,\r\n    sec: 1\r\n};\r\n\r\nconst DTMODE = {\r\n    abs: 0,\r\n    absolute: 0,\r\n    inc: 1,\r\n    increment: 1\r\n};\r\n\r\nexport default Player;"]},"metadata":{},"sourceType":"module"}